name: "Build Feature Test Package"
description: "Create a 2GP beta test package and store its id in a commit status"
inputs:
  cumulusci-version:
    description: 'version of CumulusCI to install'
    required: false
  sf-version:
    description: 'version of sf to install'
    required: false
  dev-hub-auth-url:
    description: 'sf auth URL for the Dev Hub'
    required: true
  org-name:
    description: 'Name of the scratch org config to use'
    required: true
    default: dev
  delete-scratch-org:
    type: string
    description: 'Specify whether to delete the Scratch org'
    required: false
    default: true
runs:
  using: "composite"
  steps:
    - name: Run conditional package build
      shell: bash
      run: |
        if [[ "${{ inputs.delete-scratch-org }}" == "false" ]]; then
          echo "Building Feature Test Package..."
          gh workflow run MyClubHub/cumulusci-run-flow-scratch@main \
            --with dev-hub-auth-url="${{ inputs.dev-hub-auth-url }}" \
            --with org-name="${{ inputs.org-name }}" \
            --with cumulusci-version="${{ inputs.cumulusci-version }}" \
            --with sf-version="${{ inputs.sf-version }}" \
            --with flow-name="build_feature_test_package" \
            --with commit-status-name="Build Feature Test Package" \
            --with commit-status-regex="04t[a-zA-Z0-9]*" \
            --with commit-status-description-prefix="version_id: "
        else
          echo "Building Unlocked Test Package..."
          gh workflow run MyClubHub/cumulusci-run-flow-scratch@main \
            --with dev-hub-auth-url="${{ inputs.dev-hub-auth-url }}" \
            --with org-name="${{ inputs.org-name }}" \
            --with cumulusci-version="${{ inputs.cumulusci-version }}" \
            --with sf-version="${{ inputs.sf-version }}" \
            --with flow-name="create_managed_no_validation" \
            --with commit-status-name="Build Managed Test Package" \
            --with commit-status-regex="04t[a-zA-Z0-9]*" \
            --with commit-status-description-prefix="version_id: "
        fi
